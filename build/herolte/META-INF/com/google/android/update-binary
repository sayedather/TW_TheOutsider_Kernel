#!/sbin/sh

OUTFD=$2
ZIP=$3

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}

cd /tmp
rm -rf workdir
mkdir workdir
cd workdir
unzip -o "$ZIP"

getprop ro.product.device >> device

ui_print " "
ui_print "*************************************************"
ui_print "********   The Outsider Kernel project   ********"
ui_print "******   for Galaxy S7 and Galaxy S7 edge   *****"
ui_print "*************************************************"
ui_print "*************************************************"
ui_print "**********   Galaxy S7 (flat) edition   *********"
ui_print "***   Supported models: SM-G930F/FD/W8/S/L/K   **"
ui_print "***************   Version: 1.1.0   **************"
ui_print "*************************************************"
ui_print " "
sleep 3
ui_print "  > Installing The Outsider Kernel"
ui_print "    for herolte..."

if grep -q hero2lte device; then
  ui_print "  ... aborting! Your device is hero2lte."
  ui_print "  Please download the correct release."
  ui_print "  Nothing has been modified."
  echo "Installation failed because the device is $device"
  exit 1;
else if grep -q herolte device; then
	cat herolte-eur.img > /dev/block/platform/155a0000.ufs/by-name/BOOT
	ui_print "  ... flashing kernel for herolte."
else
  ui_print "  ... aborting! Model not supported."
  ui_print "  Nothing has been modified."
  echo "Installation failed because the device is $device"
  exit 1;
fi;
fi;

ui_print "  > Mounting /system partition."
mount /system
ui_print "  > Mounting /data partition."
mount /data

cd
cd /tmp/workdir
mkdir /system/etc/init.d
ui_print "  > Installing fingerprint files."
rm -rf /system/app/mcRegistry
rm -f /system/vendor/lib/libsecure_storage.so
rm -f /system/vendor/lib64/libsecure_storage.so
mv -f mcRegistry /system/app
mv -f vendor/lib/libsecure_storage.so /system/vendor/lib/libsecure_storage.so
mv -f vendor/lib64/libsecure_storage.so /system/vendor/lib64/libsecure_storage.so

ui_print "  > Installing binaries to xbin."
rm -f /system/xbin/sqlite3
rm -f /system/xbin/zip
rm -f /system/xbin/fstrim
rm -f /system/xbin/busybox
mv -f files/sqlite3 /system/xbin
mv -f files/zip /system/xbin
mv -f files/fstrim /system/xbin
mv -f files/busybox /system/xbin

ui_print "  > Setting correct permissions."
chmod 0644 /system/vendor/lib/libsecure_storage.so
chmod 0644 /system/vendor/lib64/libsecure_storage.so
chmod 0755 /system/app/mcRegistry
chmod 0644 /system/app/mcRegistry/*.tlbin
chmod 0755 /system/xbin/sqlite3
chmod 0755 /system/xbin/zip
chmod 0755 /system/xbin/fstrim
chmod 0755 /system/xbin/busybox

ui_print "  > Unmounting /data partition."
umount /data > /dev/null 2>&1
ui_print "  > Unmounting /system partition."
umount /system > /dev/null 2>&1

ui_print " "
ui_print "Everything done!"
ui_print " "
ui_print "*************************************************"
ui_print "*************************************************"
ui_print " "
sleep 3
rm -rf /tmp/workdir
sync
